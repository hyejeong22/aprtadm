<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>V Apartment Management Page</title>

      <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

  </head>
  <body>
    <div style="text-align: right; margin-bottom: 10px">
      <a
        href="/logout"
        style="text-decoration: none; color: red; font-weight: bold"
        >ğŸ”“</a
      >
    </div>

    <div class="tabs">
      <button onclick="showTab('entryTab')">ì¶œì…ê¸°ë¡</button>
      <button onclick="showTab('registerTab')">ë“±ë¡ ê´€ë¦¬</button>

    </div>

    <div class="tab-content">
      <div id="entryTab" class="tab active">
        <h2>ì¶œì…ê¸°ë¡</h2>
        <button id="btn-owner" class="active">ì„¸ëŒ€ì£¼</button>
        <button id="btn-visitor">ë°©ë¬¸ì</button>
        <h3 id="log-title">ì„¸ëŒ€ì£¼ ì¶œì…ê¸°ë¡</h3>
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ/ì‹œê°„</th>
              <th>ë°©ë¬¸ ë™/í˜¸ìˆ˜</th>
              <th>ë°©ë¬¸ ëª©ì </th>
              <th>ì „í™”ë²ˆí˜¸</th>
            </tr>
          </thead>
          <tbody id="entryLogTable"></tbody>
        </table>
      </div>

      <!-- ë“±ë¡ê´€ë¦¬ -->
      <div id="registerTab" class="tab">
      <h2>ë“±ë¡ ê´€ë¦¬</h2>
  <div class="tabs">
    <button onclick="showRegisterSubTab('request')">ë“±ë¡ ìš”ì²­ ëª©ë¡</button>
    <button onclick="showRegisterSubTab('resident')">ë“±ë¡ ì„¸ëŒ€ì£¼ ëª©ë¡</button>
  </div>

  <!-- ë“±ë¡ ìš”ì²­ ì˜ì—­ -->
  <div id="registerRequestSection">
    <h4>ë“±ë¡ ìš”ì²­ ëª©ë¡</h4>
        {% for req in requests %}
        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px">
          <p><strong>ì£¼ì†Œ:</strong> {{ req.unit_number }}</p>
          <p><strong>ì „í™”ë²ˆí˜¸:</strong> {{ req.phone }}</p>
          <p>
            <strong>ì‚¬ì§„:</strong><br />
            <img
              src="{{ url_for('static', filename=req.face_image_path) }}"
              width="100"
            />
          </p>
          <form
            method="POST"
            action="{{ url_for('approve_request', request_id=req.id) }}"
            style="display: inline"
          >
            <button type="submit">âœ… ìŠ¹ì¸</button>
          </form>
          <form
            method="POST"
            action="{{ url_for('reject_request', request_id=req.id) }}"
            style="display: inline"
          >
            <button type="submit">âŒ ê±°ì ˆ</button>
          </form>
        </div>
        {% else %}
        <p>ë“±ë¡ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
</div>

<div id="residentSection" style="display: none">
        <h4>ë“±ë¡ëœ ëª©ë¡</h4>
        <input
          type="text"
          id="searchInput"
          placeholder="ì´ë¦„ ë˜ëŠ” ë™/í˜¸ìˆ˜ ê²€ìƒ‰..."
          oninput="filterResidents()"
          style="width: 300px; margin-bottom: 10px"
        />
        <div id="residentList"></div>
        <div id="residentPagination" style="margin-top: 10px"></div>

        <div id="editForm" style="display: none">
          <form id="editResidentForm">
            <input type="hidden" id="editId" name="id" />
            <input type="text" id="editName" name="name" required />
            <input type="text" id="editAddress" name="address" required />
            <input type="text" id="editPhone" name="phone" required />
            <input type="file" id="editPhoto" name="photo" />
            <button type="submit">ìˆ˜ì •</button>
            <button type="button" onclick="cancelEdit()">ì·¨ì†Œ</button>
          </form>
        </div>
      </div>

    <script>let allResidents = []
      let currentPage = 1
      const perPage = 5
      let totalPages = 1

      function showTab(id) {
        document
          .querySelectorAll('.tab')
          .forEach((t) => t.classList.remove('active'))
        document.getElementById(id).classList.add('active')

        if (id === 'registerTab') loadResidents()
        if (id === 'entryTab') loadEntryLogs('ì„¸ëŒ€ì£¼')
      }

      function loadEntryLogs(type) {
        fetch(`/entry_logs?type=${type}`)
          .then((res) => res.json())
          .then((data) => {
            document.getElementById('log-title').innerText = `${type} ì¶œì…ê¸°ë¡`
            const tableBody = document.getElementById('entryLogTable')
            tableBody.innerHTML = ''
            if (data.length === 0) {
              tableBody.innerHTML =
                '<tr><td colspan="5">ì¶œì…ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'
              return
            }
            data.forEach((log) => {
              const row = document.createElement('tr')
              row.innerHTML = `
              <td>${new Date(log.datetime).toLocaleString()}</td>
              <td>${log.address}</td>
              <td>${log.purpose}</td>
              <td>${log.name}</td>
              <td>${log.phone}</td>
            `
              tableBody.appendChild(row)
            })
          })
      }

      function loadResidents(page = 1) {
        fetch(`/residents?page=${page}`)
          .then((res) => res.json())
          .then((data) => {
            allResidents = data.data
            totalPages = data.total_pages
            currentPage = page
            const start = (currentPage - 1) * perPage
            const end = start + perPage
            displayResidents(allResidents.slice(start, end))
            renderPagination()
          })
      }

      function displayResidents(residents) {
        const listDiv = document.getElementById('residentList')
        listDiv.innerHTML = ''
        if (residents.length === 0) {
          listDiv.innerHTML = '<p>ë“±ë¡ëœ ì„¸ëŒ€ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
          return
        }
        residents.forEach((resident) => {
          const item = document.createElement('div')
          item.innerHTML = `
          <img src="/static/${resident.photo_filename}" width="40" height="40" style="border-radius: 50%; vertical-align: middle" />
          <strong>${resident.name}</strong> | ${resident.address} | ${resident.phone}
          <button onclick="editResident(${resident.id})">ìˆ˜ì •</button>
          <button onclick="deleteResident(${resident.id})">ì‚­ì œ</button>
        `
          listDiv.appendChild(item)
        })
      }

      function renderPagination() {
        const paginationDiv = document.getElementById('residentPagination')
        paginationDiv.innerHTML = ''
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button')
          btn.innerText = i
          btn.disabled = i === currentPage
          btn.onclick = () => loadResidents(i)
          paginationDiv.appendChild(btn)
        }
      }

      function filterResidents() {
        const query = document
          .getElementById('searchInput')
          .value.trim()
          .toLowerCase()
        const filtered = allResidents.filter(
          (r) =>
            r.name.toLowerCase().includes(query) ||
            r.address.toLowerCase().includes(query)
        )
        displayResidents(filtered)
      }

      function promptAdminPassword(callback) {
        const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:')
        if (!password) return
        fetch('/verify_password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        })
          .then((res) => res.json())
          .then((result) => {
            if (result.status === 'success') callback(password)
            else alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.')
          })
      }

      function editResident(id) {
        promptAdminPassword(() => {
          const resident = allResidents.find((r) => r.id === id)
          if (!resident) return alert('ì„¸ëŒ€ì£¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
          document.getElementById('editId').value = resident.id
          document.getElementById('editName').value = resident.name
          document.getElementById('editAddress').value = resident.address
          document.getElementById('editPhone').value = resident.phone
          document.getElementById('editForm').style.display = 'block'
          window.scrollTo(0, document.getElementById('editForm').offsetTop)
        })
      }

      function deleteResident(id) {
        promptAdminPassword((password) => {
          if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return
          fetch(`/residents/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password }),
          })
            .then((res) => {
              if (res.ok) {
                alert('âœ… ì‚­ì œ ì™„ë£Œ')
                loadResidents()
              } else {
                alert('âŒ ì‚­ì œ ì‹¤íŒ¨')
              }
            })
            .catch(() => alert('âŒ ì„œë²„ ì˜¤ë¥˜'))
        })
      }

      function cancelEdit() {
        document.getElementById('editForm').style.display = 'none'
      }

  function showTab(id) {
  document
    .querySelectorAll('.tab')
    .forEach((t) => t.classList.remove('active'))
  document.getElementById(id).classList.add('active')

  if (id === 'registerTab') {
    showRegisterSubTab('request')  // ì²˜ìŒì—” ë“±ë¡ ìš”ì²­ ë³´ì´ê²Œ
  }
  if (id === 'entryTab') {
    loadEntryLogs('ì„¸ëŒ€ì£¼')
  }
if (id === 'qrTab') {
  console.log('QR íƒ­ ì—´ë¦¼')
  const iframe = document.querySelector('#qrTab iframe')
  iframe.src = '/qr'  // ê°•ì œë¡œ reload
  iframe.style.height = '1000px' // ë†’ì´ ë³´ì¥
}
}

      document
        .getElementById('editResidentForm')
        .addEventListener('submit', function (e) {
          e.preventDefault()
          const form = e.target
          const formData = new FormData(form)
          const id = formData.get('id')
          fetch(`/residents/${id}`, {
            method: 'PUT',
            body: formData,
          }).then((res) => {
            if (res.ok) {
              alert('âœ… ìˆ˜ì • ì™„ë£Œ')
              form.reset()
              document.getElementById('editForm').style.display = 'none'
              loadResidents()
            } else {
              alert('âŒ ìˆ˜ì • ì‹¤íŒ¨')
            }
          })
        })

      document.getElementById('btn-owner').addEventListener('click', () => {
        loadEntryLogs('ì„¸ëŒ€ì£¼')
        document.getElementById('btn-owner').classList.add('active')
        document.getElementById('btn-visitor').classList.remove('active')
      })

      document.getElementById('btn-visitor').addEventListener('click', () => {
        loadEntryLogs('ë°©ë¬¸ì')
        document.getElementById('btn-owner').classList.remove('active')
        document.getElementById('btn-visitor').classList.add('active')
      })

      document.addEventListener('DOMContentLoaded', () => {
        showTab('entryTab') // ê¸°ë³¸ íƒ­ í‘œì‹œ
      })

  function showRegisterSubTab(tabName) {
    const req = document.getElementById('registerRequestSection')
    const res = document.getElementById('residentSection')

    if (tabName === 'request') {
      req.style.display = 'block'
      res.style.display = 'none'
    } else {
      req.style.display = 'none'
      res.style.display = 'block'
      loadResidents()  // ì£¼ë¯¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
   }
  }</script>
  </body>
</html>